<!DOCTYPE html>

<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!----======== CSS ======== -->
    <link rel="stylesheet" href="style.css">
    
    <!----===== Iconscout CSS ===== -->
    <link rel="stylesheet" href="https://unicons.iconscout.com/release/v4.0.0/css/line.css">

    <link rel="icon" type="image/x-icon" href="./favicon.png">

    <title>Information Form </title> 
</head>

<body>

<div class="preloader" data-preloader>
    <div class="preloader-inner">
        <img class="img" src="/assets/images/favicon.png" width="40" height="40" alt="" >
    </div>
</div>


    <div class="container">
        <header>Information</header>

        <form action="#" class="user-data">
            <div class="form first">
                <div class="details personal">
                    <span class="title">Personal Details</span>

                    <div class="fields">
                        <div class="input-field">
                            <label>User Name</label>
                            <input type="text" placeholder="Enter your name" id="name" required>
                        </div>

                        
                        
                        <div class="input-field">
                            <label>Bio Text</label>
                            <input type="text" placeholder="BIO" id="bio">
                        </div>

                            
                        
                        <!-- This img should be replaced with the one the    user upload  -->
                        

                        
                        
                        <div class="input-field1" class="img-input">
                            <label for="inputTag">
                                <div><img id="profileImg" src="/form/image.avif" alt="img"></div> 
                                <span> Select Image</span> 
                                <input id="inputTag" type="file" accept="image/*"/>
                            </label>
                        </div>

                        
                        
                        

                        
                </div>

                <br>

                <div class="details ID">
                    
                    <span class="title"> Social Links  </span>

                    <div class="fields">
                        
                        <div class="input-field">
                            <label>Phone Number</label>
                            <input type="tel" placeholder="Enter Phone number" id="phone">
                        </div>

                        <div class="input-field">
                            <label>Email</label>
                            <input type="text" placeholder="Enter your email" id="email">
                        </div>
                        
                        <div class="input-field">
                            <label>Work Email</label>
                            <input type="text" placeholder="Enter your work email" id="work-email">
                        </div>


                        <div class="input-field">
                            <label>Whatsapp</label>
                            <input type="tel" placeholder="Enter Whatsapp number" id="whatsapp">
                        </div>

                        <div class="input-field">
                            <label>Telegram</label>
                            <input type="tel" placeholder="Enter your Telegram link" id="telegram">
                        </div>

                        <div class="input-field">
                            <label>Youtube</label>
                            <input type="url" placeholder="Enter your Youtube link" id="youtube">
                        </div>

                        <div class="input-field">
                            <label>Twitter</label>
                            <input type="url" placeholder="Enter your Twitter link" id="twitter">
                        </div>

                        <div class="input-field">
                            <label>Facebook</label>
                            <input type="url" placeholder="Enter your Facebook link" id="facebook">
                        </div>

                        <div class="input-field">
                            <label>Instagram</label>
                            <input type="url" placeholder="Enter your Instagram link" id="instagram">
                        </div>

                        <div class="input-field">
                            <label>LinkedIn</label>
                            <input type="url" placeholder="Enter your LinkedIn link" id="linkedin">
                        </div>

                        <div class="input-field">
                            <label>Tiktok</label>
                            <input type="url" placeholder="Enter your Tiktok link" id="tiktok">
                        </div>

                        <div class="input-field">
                            <label>SnapChat</label>
                            <input type="url" placeholder="Enter your SnapChat link" id="snapchat">
                        </div>

                        <div class="input-field">
                            <label>Threads</label>
                            <input type="url" placeholder="Enter your Threads link" id="threads">
                        </div>

                        <div class="input-field">
                            <label>Instapay</label>
                            <input type="url" placeholder="Enter your Instapay link" id="instapay">
                        </div>

                        <div class="input-field">
                            <label>Website</label>
                            <input type="url" placeholder="Enter your Web Page link" id="website">
                        </div>

                        <div class="input-field">
                            <label>Behance</label>
                           <input type="url" placeholder="Enter your Behance link" id="behance">
                        </div>

                    

                    <div class="input-field">
                        <label>Veseeta</label>
                       <input type="url" placeholder="Enter your Veseeta link" id="veseeta">
                    </div>
                    
                    
                    <div class="input-field">
                        <label>Calendly</label>
                       <input type="url" placeholder="Enter your Calendly link" id="calendly">
                    </div>

                    <div class="input-field">
                        <label>Name on file</label>
                        <input type="text" id="file-label" placeholder="Add file name">
                    </div>

                        
                    <div class="input-field file">
                        
                        <label for="file">Choose file to upload</label>
                        <input type="file" id="file" name="file" multiple />
                    </div>
            </div>



                    <div class="buttons">
                        
                        
                        <button class="saveBtn">
                            <!-- <span class="btnText">Save</span> -->
                            Save
                            <i class="uil uil-cloud-check"></i>
                            
                        </button>

                        <button class="publicBtn">
                            <!-- <span class="btnText">Public view</span> -->
                            Public View
                            <i class="uil uil-navigator"></i>
                        </button>

                        
                        
                    </div>



            </div>
                </div> 
            </div>
        </form>
    </div>

    <script src="script.js"></script>

        <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-analytics.js";
        import { getAuth, setPersistence, browserLocalPersistence, updateProfile } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-auth.js";
        import { getStorage, ref, uploadBytesResumable, getDownloadURL, deleteObject, listAll, } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-storage.js";
        import { getDatabase, ref as dbRef, set, get } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-database.js";

        // Your web app's Firebase configuration
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
            apiKey: "AIzaSyDJwVzw1VhKE0Ui8mxd7S3JsawrRgXAZhQ",
            authDomain: "linqup-web.firebaseapp.com",
            projectId: "linqup-web",
            storageBucket: "linqup-web.appspot.com",
            messagingSenderId: "52682549828",
            appId: "1:52682549828:web:3ed79cb0af3296cc436a11",
            measurementId: "G-1RJTNKZG69"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);

        // Initialize Firebase Auth
        const auth = getAuth();

        // print user info
        const user = auth.currentUser;
        auth.onAuthStateChanged((user) => {

            if (user) {
                // User is signed in
                const uid = user.uid;
                const storage = getStorage();
                const storageRefImg = ref(storage, 'users/' + uid + '/profile.jpg');

                const database = getDatabase();
                const userRef = dbRef(database, 'users/' + uid);

                const profileImage = document.querySelector('#profileImg');
                getDownloadURL(storageRefImg).then((url) => {
                    profileImage.src = url;
                    // remove preloader
                    const preloader = document.querySelector("[data-preloader]");
                    profileImage.onload = () => {
                        preloader.classList.add('remove');
                    }
                }).catch((error) => {
                        // Handle any errors
                        console.log(error);
                    });

                // Make files field required if files are uploaded
                const fileField = document.querySelector('#file');
                const fileLabel = document.querySelector('#file-label');
                fileField.addEventListener('change', () => {
                    if (fileField.files.length > 0) {
                        fileLabel.required = true;
                    } else {
                        fileLabel.required = false;
                    }
                });

                // Update image when uploaded
                const imageField = document.querySelector('#inputTag');
                imageField.addEventListener('change', () => {
                    if (imageField.files.length > 0) {
                        const image = imageField.files[0];
                        profileImage.src = URL.createObjectURL(image);
                    }
                });

                // Get user data
                const name = document.querySelector('#name');
                const bio = document.querySelector('#bio');
                const email = document.querySelector('#email');
                const phone = document.querySelector('#phone');
                const website = document.querySelector('#website');
                const facebook = document.querySelector('#facebook');
                const twitter = document.querySelector('#twitter');
                const instagram = document.querySelector('#instagram');
                const linkedin = document.querySelector('#linkedin');
                const tiktok = document.querySelector('#tiktok');
                const snapchat = document.querySelector('#snapchat');
                const threads = document.querySelector('#threads');
                const instapay = document.querySelector('#instapay');
                const behance = document.querySelector('#behance');
                const veseeta = document.querySelector('#veseeta');
                const calendly = document.querySelector('#calendly');

                name.value = user.displayName;

                get(userRef).then((snapshot) => {
                    if (snapshot.exists()) {
                        // name.value = snapshot.val().name;
                        bio.value = snapshot.val().bio;
                        email.value = snapshot.val().email;
                        phone.value = snapshot.val().phone;
                        website.value = snapshot.val().website;
                        facebook.value = snapshot.val().facebook;
                        twitter.value = snapshot.val().twitter;
                        instagram.value = snapshot.val().instagram;
                        linkedin.value = snapshot.val().linkedin;
                        tiktok.value = snapshot.val().tiktok;
                        snapchat.value = snapshot.val().snapchat;
                        threads.value = snapshot.val().threads;
                        instapay.value = snapshot.val().instapay;
                        behance.value = snapshot.val().behance;
                        veseeta.value = snapshot.val().veseeta;
                        calendly.value = snapshot.val().calendly;
                        fileLabel.value = snapshot.val().fileLabel;
                    } else {
                        console.log("No data available");
                    }
                }).catch((error) => {
                    console.error(error);
                });

                // Submit form
                document.querySelector('.user-data').addEventListener('submit', async (e) => {
                    e.preventDefault();

                    // Save user data
                    // Update user profile
                    await updateProfile(user, {
                        displayName: name.value,
                    });

                    set(userRef, {
                        // name: name.value,
                        bio: bio.value,
                        email: email.value,
                        phone: phone.value,
                        website: website.value,
                        facebook: facebook.value,
                        twitter: twitter.value,
                        instagram: instagram.value,
                        linkedin: linkedin.value,
                        tiktok: tiktok.value,
                        snapchat: snapchat.value,
                        threads: threads.value,
                        instapay: instapay.value,
                        behance: behance.value,
                        veseeta: veseeta.value,
                        calendly: calendly.value,
                        fileLabel: fileLabel.value,
                    });

                    // Upload image and files
                    const image = document.querySelector('#inputTag').files[0];
                    const file = fileField.files;
                    const filesPath = 'users/' + uid + '/files/';
                    const filesPathRef = ref(storage, filesPath);

                    try {
                        if (image) {
                            const uploadTask = uploadBytesResumable(storageRefImg, image);
                            console.log("Uploaded image");
                        }
                        if (file.length > 0) {
                            listAll(filesPathRef).then((res) => {
                                res.items.forEach((itemRef) => {
                                    deleteObject(itemRef).then(() => {
                                        console.log("Deleted files");
                                    }).catch((error) => {
                                            console.log(error);
                                        });
                                });
                            }).catch((error) => {
                                    console.log(error);
                                });

                            for (let i = 0; i < file.length; i++) {
                                const storageRefFile = ref(storage, filesPath + file[i].name);
                                const uploadTask = uploadBytesResumable(storageRefFile, file[i]);
                                console.log("Uploaded files");
                            }
                        }
                    } catch (e) {
                        /* handle error */
                        alert("Error uploading");
                        console.log(e);
                    }
                });

                // Public view button
                const publicBtn = document.querySelector('.publicBtn');
                publicBtn.addEventListener('click', () => {
                    window.location.href = '/user/' + uid;
                });

            } else {
                // User is signed out
                window.location.href = '/';
            }

        });

        </script>
</body>
</html>
